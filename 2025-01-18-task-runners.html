<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>お試しタスクランナー (make, just, shake, ..) - toybeam</title>
    <meta name="description" content="devlog of toyboot4e" />
    <link rel="stylesheet" href="/style/simple.min.css" />
    <link rel="stylesheet" href="/style/style.css" />
    <link rel="stylesheet" href="/style/prism.css" />
    <script type="text/javascript" src="/style/style.js"></script>
    <script type="text/javascript" async="" src="/style/prism.js"></script>
    <!-- MathJax -->
    <script
      type="text/javascript"
      async=""
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML"
    ></script>
  </head>
  <body>
    <header role="banner">
      <h1>お試しタスクランナー (make, just, shake, ..)</h1>
      <p>Jan 18, 2025</p>
      <nav role="navigation">
        <a href="/index.html">Home</a><a href="https://github.com/toyboot4e">GitHub</a>
      </nav>
    </header>
    <main role="main">
      <h2 id="背景"><a href="#背景">背景</a></h2>
      <p>
        日頃長いコマンドを打つことが多く、
        <a href="https://github.com/fish-shell/fish-shell">fish</a>
        のコマンド履歴に頼り切りになっています。何度も履歴を遡ると、それなりの手間です。<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ # テスト実行
$ cabal test --enable-options

$ # 特定のテスト実行
$ cabal test --enable-options --test-options '-p /SegTree/'

$ # doctest の実行
$ cabal repl --with-ghc=doctest --repl-options='-w -Wdefault'

$ # などなど
</code></pre>
      </div>

      <p>ここではタスクランナーを導入し、より簡単にコマンドを打てるようにします。<br /></p>
      <h2 id="タスクランナー"><a href="#タスクランナー">タスクランナー</a></h2>
      <p>haskell-jp の皆様の動向を伺いつつ、幾つかのタスクランナーを試してみました。<br /></p>
      <h3 id="bash">
        <a href="#bash"><code>bash</code></a>
      </h3>
      <p>
        無意識に選択肢から外していましたが、凄腕の方も <code>bash</code> を使われていました。僕も
        <code>man bash</code> を読んだので bash script が書けます:<br />
      </p>

      <details>
        <summary><code>x</code> スクリプト</summary>
        <div class="org-src-container">
          <pre><code class="src language-bash">#!/usr/bin/env -S bash -euE

IFS=$'\n\t'
_ME="$(basename "$0")"

_cmd_help() {
    cat &lt;&lt;EOS
${_ME} is a simple task runner

help       Shows this message
doctest    Generates Haddock document
test       Runs cabal test
EOS
}

_cmd_doctest() {
    cd "$(dirname "$0")"
    cabal repl --with-ghc=doctest --repl-options='-w -Wdefault' "$@"
}

_cmd_test() {
    cd "$(dirname "$0")"
    cabal test --enable-tests --test-options ''"$@"
}

_run() {
    if [ $# -eq 0 ] ; then
        _cmd_help "$@"
        return
    fi

    local _cmd="${1}"
    shift 1

    case "${_cmd}" in
        'h' | 'help' | '-h' | '--help')
            _cmd_help "$@" ;;
        'dt' | 'doctest')
            _cmd_doctest "$@" ;;
        't' | 'test')
            _cmd_test "$@" ;;
        *)
            echo "no such command ${_cmd}" ;;
    esac
}

_run "$@"
</code></pre>
        </div>
      </details>

      <p>使い勝手は良いと思います:<br /></p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 1: </span>ヘルプ表示</label
        >
        <pre><code class="src language-sh">$ ./x
x is a simple task runner

help       Shows this message
doctest    Generates Haddock document
test       Runs cabal test
</code></pre>
      </div>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 2: </span><code>doctest</code> を実行</label
        >
        <pre><code class="src language-sh">$ ./x dt
</code></pre>
      </div>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 3: </span
          ><code>SegTree</code> にマッチするテストを実行</label
        >
        <pre><code class="src language-sh">$ ./x t '-p /SegTree/'
</code></pre>
      </div>

      <p>
        サブコマンドを
        <a href="https://github.com/junegunn/fzf">fzf</a>
        で選ぶようにしても良いですね。問題は、見ての通りスクリプトが長く、スマートではありません。よりきらびやかな世界を探してみます。<br />
      </p>
      <h3 id="make">
        <a href="#make"><code>make</code></a>
      </h3>
      <p>
        <code>make</code>
        も無意識に選択肢から除外していましたが、やはり凄腕の方々が使われており、普通に便利なツールに見えます。
        <a href="https://www.sigbus.info/compilerbook">compilerbook</a> (挫折) 以来ですが、
        <code>Makefile</code> も試してみます。<br />
      </p>
      <h4 id="主な文法"><a href="#主な文法">主な文法</a></h4>
      <p>
        <code>make &lt;target&gt;</code> で定義されたコマンドを実行できます。参考:
        <a href="https://makefiletutorial.com/">Makefile Tutorial</a><br />
      </p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 4: </span><code>Makefile</code> の主な文法</label
        >
        <pre><code class="src language-make">target: prerequisites
	command
</code></pre>
      </div>

      <ul>
        <li>シェルコマンドの <code>$</code> は <code>$$</code> の形でエスケープします<br /></li>
        <li><code>@</code> を付けるとコマンドの実行履歴の表示を抑制できます<br /></li>
      </ul>
      <h4 id="(脱線) Emacs でタブ文字を表示する">
        <a href="#(脱線) Emacs でタブ文字を表示する">(脱線) Emacs でタブ文字を表示する</a>
      </h4>
      <p>エディタの設定でタブ文字と行末の空白を表示します:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-elisp">(setopt show-trailing-whitespace t)
(setopt whitespace-style '(tabs  tab-mark))
(require 'whitespace)
(global-whitespace-mode 1)
</code></pre>
      </div>

      <p>
        <a href="https://github.crookster.org/macOS-Emacs-26-display-line-numbers-and-me/"
          >この記事</a
        >
        を参考に、サイドバー (<a href="https://github.com/jaypei/emacs-neotree">neotree</a>)
        ではタブ表示 (と行番号表示) を抑制します:<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-elisp">(defun my-neotree-setup (&amp;rest _)
  (display-line-numbers-mode -1)
  (whitespace-mode -1))

:hook (neo-after-create-hook . my-neotree-setup)
</code></pre>
      </div>

      <p>準備できました:<br /></p>

      <figure>
        <img src="./img/2025-01-18-tabs.png" alt="2025-01-18-tabs.png" /><br />

        <figcaption><span class="figure-number">Figure 1: </span>タブ文字を可視化</figcaption>
      </figure>
      <h4 id="リスト"><a href="#リスト">リスト</a></h4>
      <p>
        まずはサブコマンド (<em>target</em>) の一覧を表示してます。 Stack overflow
        からコマンドを拾ってきました:<br />
      </p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 5: </span><code>Makefile</code></label
        >
        <pre><code class="src language-makefile">.PHONY: help
help:	## Shows this help.
	@echo 'Makefile targets'
	@echo ''
	@sed -ne '/@sed/!s/## //p' $(MAKEFILE_LIST)

.PHONY: doctest
doc:	## Runs doctest.
	cabal repl --with-ghc=doctest --repl-options='-w -Wdefault'

.PHONY: test
test:		## Runs local test
	cabal test --enable-tests --test-options "$(p)"
</code></pre>
      </div>

      <p>これで target の一覧を表示できます:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ make
Makefile targets

help:	Shows this help.
doc:	Runs doctest.
test:	Runs local test.
</code></pre>
      </div>

      <p>
        ただ <code>target: prerequisites</code> の形でコマンドを書くと破綻します。また最近の
        <code>make</code> には <code>--print-targets</code> オプションもあるとか。<br />
      </p>
      <h4 id="エイリアスを定義する"><a href="#エイリアスを定義する">エイリアスを定義する</a></h4>
      <p>エイリアス相当の target も作れます:<br /></p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 6: </span><code>Makefile</code></label
        >
        <pre><code class="src language-make">.PHONY: t
t: test
</code></pre>
      </div>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ make t
</code></pre>
      </div>
      <h4 id="引数を渡す"><a href="#引数を渡す">引数を渡す</a></h4>
      <p>Target に引数を渡すためには、 <code>arg=value</code> の形で変数定義します:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-makefike">.PHONY: test
test:		## Runs local test
	cabal test --enable-tests --test-options "$(p)"
</code></pre>
      </div>

      <p>あまり使い勝手は良くないですね:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ make test p='-p /SegTree'
cabal test --enable-tests --test-options "-p /SegTree"
Build profile: -w ghc-9.8.4 -O1
In order, the following will be built (use -v for more details):
 - ac-library-hs-1.1.0.0 (test:ac-library-hs-test) (file /home/tbm/dev/hs/ac-library-hs/dist-newstyle/build/x86_64-linux/ghc-9.8.4/ac-library-hs-1.1.0.0/cache/build changed)
 - ac-library-hs-1.1.0.0 (test:benchlib-test) (file /home/tbm/dev/hs/ac-library-hs/dist-newstyle/build/x86_64-linux/ghc-9.8.4/ac-library-hs-1.1.0.0/cache/build changed)
</code></pre>
      </div>

      <p>
        <a href="https://qiita.com/algas/items/499d0d69d51a1cc7639f">強引に引数を扱うハック</a>
        も見ましたが、制限があります。<br />
      </p>
      <h4 id="サブディレクトリからの実行">
        <a href="#サブディレクトリからの実行">サブディレクトリからの実行</a>
      </h4>
      <p>サブディレクトリからは <code>make &lt;target&gt;</code> できませんでした。残念。<br /></p>
      <h3 id="just">
        <a href="#just"><code>just</code></a>
      </h3>
      <p>
        <a href="https://github.com/casey/just">just</a> もベター
        <code>make</code> に見えます。<br />
      </p>
      <h4 id="エディタの設定 (Emacs)">
        <a href="#エディタの設定 (Emacs)">エディタの設定 (Emacs)</a>
      </h4>
      <div class="org-src-container">
        <pre><code class="src language-elisp">;; https://github.com/leon-barrett/just-mode.el/blob/main/just-mode.el
(leaf just-mode) ;; :ensure t

;; https://github.com/psibi/justl.el
(leaf justl)
</code></pre>
      </div>
      <h4 id="シェルの設定 (fish)">
        <a href="#シェルの設定 (fish)">シェルの設定 (<code>fish</code>)</a>
      </h4>
      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 7: </span><code>config.fish</code></label
        >
        <pre><code class="src language-sh">if command -sq just
    alias j just
end
</code></pre>
      </div>
      <h4 id="Justfile"><a href="#Justfile">Justfile</a></h4>
      <p>早速使ってみます。先程の <code>Makefile</code> より綺麗です:<br /></p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 8: </span><code>Justfile</code></label
        >
        <pre><code class="src language-makefile"># shows this help message
help:
    @just -l

# runs the benchmark
bench:
    cabal bench --benchmark-options='--output a.html'

# generates Haddock document
doc:
    cabal haddock "$@"

[private]
alias d := doc

test opts='':
    cabal test --enable-tests --test-options '{{opts}}'

[private]
alias t := test

# 略
</code></pre>
      </div>

      <p>リスト表示が素敵です:<br /></p>

      <figure>
        <img src="./img/2025-01-18-just.png" alt="2025-01-18-just.png" /><br />

        <figcaption><span class="figure-number">Figure 2: </span><code>just</code></figcaption>
      </figure>

      <p>実際のコマンド実行も良い感じに:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ just t
$ just t '-p /SegTree'/
$ just dt
</code></pre>
      </div>

      <p>その他メリットとしては、<br /></p>

      <ul>
        <li><code>$</code> のエスケープが必要ありませんでした。<br /></li>
        <li>
          サブディレクトリから
          <code>just</code> コマンド実行すると、ルートからの実行になりました。<br />
        </li>
      </ul>
      <h3 id="task">
        <a href="#task"><code>task</code></a>
      </h3>
      <p>
        <a href="https://taskfile.dev/usage/"><code>task</code></a>
        も良さそうですね。未だに書いたことがありませんが、 GitHub Actions
        の独自言語に近そうです。<br />
      </p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 9: </span><code>Taskfile.yml</code></label
        >
        <pre><code class="src language-yml">version: '3'

tasks:
  doctest:
    aliases: [dt]
    cmds:
      - cabal repl --with-ghc=doctest --repl-options='-w -Wdefault'

  test:
    aliases: [t]
    cmds:
      - cabal test --enable-tests --test-options ''{{.CLI_ARGS}}
</code></pre>
      </div>

      <p>
        引数を渡すには <code>--</code> で区切る必要がありそうです。これだけちょっと面倒です:<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ task t -- '-p /SegTree/'
</code></pre>
      </div>
      <h3 id="cargo-make">
        <a href="#cargo-make"><code>cargo-make</code></a>
      </h3>
      <p>
        <a href="https://github.com/sagiegurari/cargo-make"><code>cargo-make</code></a> もベター
        <code>make</code> 的なツールです。 <code>cargo make</code> として実行できる他、
        <code>makers</code> がスタンドアローン版としてインストールされます。<br />
      </p>

      <p>Rust プロジェクトを前提にしている節はあります:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ makers
[cargo-make] INFO - cargo make 0.37.23
[cargo-make] INFO -
[cargo-make] INFO - Build File: Makefile.toml
[cargo-make] INFO - Task: default
[cargo-make] INFO - Profile: development
[cargo-make] INFO - Execute Command: "cargo" "fmt"
`cargo metadata` exited with an error: error: could not find `Cargo.toml` in `/home/tbm/dev/hs/ac-library-hs/verify` or any parent directory

This utility formats all bin and lib files of the current crate using rustfmt.

Usage: cargo fmt [OPTIONS] [-- &lt;rustfmt_options&gt;...]
</code></pre>
      </div>

      <p><code>Makefile.toml</code> を書いてみます:<br /></p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 10: </span><code>Makefile.toml</code></label
        >
        <pre><code class="src language-haskell">[tasks.bench]
alias = "b"
command = "cabal"
args = ["bench", "--benchmark-options='--output a.html'"]

[tasks.doc]
command = "cabal"
args = ["haddock", "$@"]

[tasks.d]
alias = "doc"

[tasks.test]
command = "cabal"
args = ["test", "--enable-tests", "--test-options", "${@:}"]

[tasks.t]
alias = "test"
</code></pre>
      </div>

      <p>ちゃんと使えますね:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ makers t
$ makers t '-p /SegTree/'
</code></pre>
      </div>

      <p>
        サブディレクトリから実行すると、親ディレクトリの
        <code>Makefile.toml</code> を見つけてくれませんでした。そこは残念です。<br />
      </p>
      <h3 id="shake">
        <a href="#shake"
          ><a href="https://github.com/ndmitchell/shake"><code>shake</code></a></a
        >
      </h3>
      <p>
        <a href="https://github.com/ndmitchell/shake"><code>shake</code></a> も
        <code>make</code> の代替です。タスクランナーとしても利用できます:<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-haskell">{- cabal:
build-depends: base, shake
-}

import Development.Shake
import Development.Shake.Command
import Development.Shake.FilePath
import Development.Shake.Util

main :: IO ()
main = shakeArgs shakeOptions {shakeFiles = "_build"} $ do
  phony "doc" $ do
    cmd_ ["cabal", "haddock"]

  phony "doctest" $ do
    cmd_ ["cabal", "repl", "--with-ghc=doctest", "--repl-options='-w -Wdefault'"]

  -- alias の代わり
  phony "dt" $ need ["doctest"]

  phony "test" $ do
    cmd_ ["cabal", "test", "--enable-tests"]

  phony "t" $ need ["test"]
</code></pre>
      </div>

      <p>呼び出し方はもう少しスマートにしたいところです:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ cabal run Shakefile.hs -- t
</code></pre>
      </div>

      <p>
        リスト機能は
        <a href="https://github.com/ndmitchell/shake/issues/107#issuecomment-303232225"
          >minad 神からもリクエストされていました</a
        >:<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ cabal run Shakefile.hs -- --help
&lt;略&gt;
Targets:
  - doc
  - doctest
  - dt
  - test
  -
</code></pre>
      </div>

      <p>
        引数を受け取るには
        <a
          href="https://hackage.haskell.org/package/shake-0.19.8/docs/Development-Shake.html#v:shakeArgsWith"
          ><code>shakeArgsWith</code></a
        >
        を使うことになりそうですが、使い方を理解するのが大変そうです。<br />
      </p>
      <h3 id="その他の選択肢"><a href="#その他の選択肢">その他の選択肢</a></h3>
      <ul>
        <li>
          <a href="https://github.com/matklad/cargo-xtask"><code>cargo-xtask</code></a
          ><br />
          参考:
          <a href="https://matklad.github.io/2018/01/03/make-your-own-make.html"
            >Make your own make</a
          ><br />
        </li>

        <li><code>nix run</code><br /></li>
      </ul>
      <h2 id="感想"><a href="#感想">感想</a></h2>
      <p>
        シンプルなタスクランナーとしては、
        <a href="https://github.com/casey/just"><code>just</code></a> と
        <a href="https://taskfile.dev/usage/"><code>task</code></a> が良さそうです。特に
        <code>just</code> が好みだったので、僕のリポジトリには追加していくと思います。<br />
      </p>
    </main>
    <footer role="contentinfo">
      <p>Styled with <a href="https://simplecss.org/">Simple.css</a></p>
      <div><a href="/index.html">Home</a><a href="https://github.com/toyboot4e">GitHub</a></div>
    </footer>
  </body>
</html>
