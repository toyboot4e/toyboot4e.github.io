<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PHP 速習 (ナップサック問題) - toybeam</title>
    <meta name="description" content="devlog of toyboot4e" />
    <link rel="stylesheet" href="/style/simple.min.css" />
    <link rel="stylesheet" href="/style/style.css" />
    <link rel="stylesheet" href="/style/prism.css" />
    <script type="text/javascript" src="/style/style.js"></script>
    <script type="text/javascript" async="" src="/style/prism.js"></script>
    <!-- MathJax -->
    <script
      type="text/javascript"
      async=""
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML"
    ></script>
  </head>
  <body>
    <header role="banner">
      <h1>PHP 速習 (ナップサック問題)</h1>
      <p>Nov 5, 2024</p>
      <nav role="navigation">
        <a href="/index.html">Home</a><a href="https://github.com/toyboot4e">GitHub</a>
      </nav>
    </header>
    <main role="main">
      <p>PHP 8.2 を環境構築し、ナップサック問題を解いてみました。<br /></p>
      <h2 id="環境構築"><a href="#環境構築">環境構築</a></h2>
      <p>PHP のセットアップは初めてです。<br /></p>
      <h3 id="AtCoder のジャッジ環境の確認">
        <a href="#AtCoder のジャッジ環境の確認">AtCoder のジャッジ環境の確認</a>
      </h3>
      <p>
        <a href="https://img.atcoder.jp/file/language-update/language-list.html"
          >AtCoder のジャッジ環境</a
        >
        から PHP の実行環境を調べました。 <strong>PHP 8.2</strong> を使っています。今どきの PHP
        なら、僕にも使いこなせるでしょうか。<br />
      </p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 1: </span>コンパイルコマンド</label
        >
        <pre><code class="src language-php">php -l Main.php &amp;&amp; touch OK
</code></pre>
      </div>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 2: </span>実行コマンド</label
        >
        <pre><code class="src language-sh">php Main.php
</code></pre>
      </div>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 3: </span>ライブラリ</label
        >
        <pre><code class="src language-txt">php8.2-gmp
php8.2-bcmath
php8.2-sqlite3
</code></pre>
      </div>
      <h3 id="インストール (Nix Flakes)">
        <a href="#インストール (Nix Flakes)">インストール (Nix Flakes)</a>
      </h3>
      <p>
        <a href="https://github.com/loophp/nix-shell">loophp/nix-shell</a>
        を使ってインストールしてみます。この辺りは
        <a
          href="https://fortee.jp/phpcon-fukuoka-2024/proposal/fde5c43f-885e-455b-9b4f-6fdb4c697a19"
          >たけてぃ氏</a
        >
        が詳しそうですが、 PHP こそ Nix が活躍する場面ではないでしょうか。<br />
      </p>

      <p>テンプレートが用意されているので、使ってみます。<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ nix flake init --template github:loophp/nix-shell#basic
wrote: /home/tbm/dev/php/atcoder-php/flake.lock
wrote: /home/tbm/dev/php/atcoder-php/README.md
wrote: /home/tbm/dev/php/atcoder-php/flake.nix
wrote: /home/tbm/dev/php/atcoder-php/.envrc
</code></pre>
      </div>

      <p><code>nix-direnv</code> で <code>PATH</code> を通します。<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ direnv allow
direnv: loading ~/dev/php/atcoder-php/.envrc
direnv: using flake
[1/0/1 copied (69.6/142.6 MiB), 11.2/23.3 MiB DL] fetching source from https://cache.nixos.orgdirenv: ([/nix/store/3mydh7746lji25ry2aygsy5i4s0i23x2-direnv-2.35.0/bin/direnv export fish]) is taking a while to execute. Use CTRL-C to give up.
direnv: export +CONFIG_SHELL +HOST_PATH +IN_NIX_SHELL +NIX_BUILD_CORES +NIX_BUILD_TOP +NIX_CFLAGS_COMPILE +NIX_ENFORCE_NO_NATIVE +NIX_LDFLAGS +NIX_STORE +SOURCE_DATE_EPOCH +TEMP +TEMPDIR +TMP +TMPDIR +__structuredAttrs +buildInputs +buildPhase +builder +cmakeFlags +configureFlags +depsBuildBuild +depsBuildBuildPropagated +depsBuildTarget +depsBuildTargetPropagated +depsHostHost +depsHostHostPropagated +depsTargetTarget +depsTargetTargetPropagated +doCheck +doInstallCheck +dontAddDisableDepTrack +mesonFlags +name +nativeBuildInputs +out +outputs +patches +phases +preferLocalBuild +propagatedBuildInputs +propagatedNativeBuildInputs +shell +shellHook +stdenv +strictDeps +system ~PATH ~XDG_DATA_DIRS
</code></pre>
      </div>

      <p>これで PHP が <code>PATH</code> に入りました。しかし PHP のバージョンが 8.1 です:<br /></p>

      <div class="org-src-container">
        <pre><code class="src language-sh">$ php --version
PHP 8.1.24 (cli) (built: Sep 26 2023 23:43:49) (NTS)
Copyright (c) The PHP Group
Zend Engine v4.1.24, Copyright (c) Zend Technologies
    with Zend OPcache v8.1.24, Copyright (c), by Zend Technologies
</code></pre>
      </div>

      <p>PHP 8.2 に差し替えてインストール完了とします。<br /></p>

      <div class="org-src-container">
        <label class="org-src-name"
          ><span class="listing-number">Listing 4: </span><code>flake.nix</code></label
        >
        <pre><code class="src language-diff-php diff-highlight">-            php = pkgs.php81; # Change to php56, php70, ..., php81, php82, php83 etc.
+            php = pkgs.php82; # Change to php56, php70, ..., php81, php82, php83 etc.
</code></pre>
      </div>

      <div class="org-src-container">
        <pre><code class="src language-php">$ php --version
PHP 8.2.11 (cli) (built: Sep 26 2023 11:11:58) (NTS)
Copyright (c) The PHP Group
Zend Engine v4.2.11, Copyright (c) Zend Technologies
    with Zend OPcache v8.2.11, Copyright (c), by Zend Technologies
</code></pre>
      </div>

      <p>普通はここまで簡単に行きませんが、整備されていて助かりました。<br /></p>

      <blockquote>
        <p>
          <code>drupal</code> など余分なパッケージが入っていますが、ひとまず良しとします。<br />
        </p>
      </blockquote>
      <h3 id="Emacs の環境構築"><a href="#Emacs の環境構築">Emacs の環境構築</a></h3>
      <h4 id="php-mode">
        <a href="#php-mode"><code>php-mode</code></a>
      </h4>
      <p>
        <a href="https://github.com/emacs-php/php-mode">emacs-php/php-mode</a> は tadsan
        氏がメインメンテナの Emacs
        パッケージです。自分がお世話になる日が来るとは思いませんでした。<br />
      </p>

      <p>
        README の内容を <code>leaf</code> 式に起こすとこんな感じです (※ 正確さは不確かです):<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-elisp">(leaf php-mode
  :custom
  ((php-mode-coding-style . 'psr2)
   (php-mode-template-compatibility . nil)
   (php-imenu-generic-expression . 'php-imenu-generic-expression-simple))
  :defer-config
  (subword-mode 1)
  (setq-local show-trailing-whitespace t)
  (setq-local ac-disable-faces '(font-lock-comment-face font-lock-string-face))
  (add-hook 'hack-local-variables-hook 'php-ide-turn-on nil t)
  (when (require 'flycheck nil)
    (add-to-list 'flycheck-disabled-checkers 'php-phpmd)
    (add-to-list 'flycheck-disabled-checkers 'php-phpcs)))
</code></pre>
      </div>
      <h4 id="flycheck-phpstan + flycheck-inline-mode">
        <a href="#flycheck-phpstan + flycheck-inline-mode"
          ><code>flycheck-phpstan</code> + <code>flycheck-inline-mode</code></a
        >
      </h4>
      <p>
        <a href="https://phpstan.org/">PHPStan</a> が PHP の静的解析ツールのように見えます。
        <a href="https://github.com/emacs-php/flycheck-phpstan.el">emacs-php/flycheck-phpstan.el</a>
        を導入します:<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-elisp">(leaf flycheck-phpstan
  :init
  (defun my-flycheck-phpstan-setup ()
    (flycheck-mode t))
  :hook (php-mode-hook . my-flycheck-phpstan-setup)
  :defer-config
  (flycheck-mode t)
  (flycheck-inline-mode t))
</code></pre>
      </div>

      <p>これにて構文エラーがリアルタイムで表示されるようになりました:<br /></p>

      <figure>
        <img src="./img/2024-11-05-phpstan.png" alt="2024-11-05-phpstan.png" width="388px" /><br />

        <figcaption>
          <span class="figure-number">Figure 1: </span><code>flycheck-phpstan.el</code> +
          <code>flycheck-inline-mode</code>
        </figcaption>
      </figure>

      <p>他にも <code>composer</code> など様々なツールがあるようですが、今回は無視します。<br /></p>
      <h2 id="演習"><a href="#演習">演習</a></h2>
      <h3 id="標準入出力のテンプレート">
        <a href="#標準入出力のテンプレート">標準入出力のテンプレート</a>
      </h3>
      <p>
        競技プログラミングの解答プログラムは、標準入出力を通じてジャッジとデータをやり取りします。最低限、標準入出力のイディオムを見つける必要があります。<br />
      </p>

      <p>
        <a href="https://qiita.com/noko206/items/800649132ff050635ff0"
          >【PHP】標準入力・標準出力を楽に記述するための工夫【AtCoder】</a
        >
        を参考にテンプレートを作成しました。<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-php">// 標準入力を 1 行読み、単語列に分解する
function words() {
    return explode(' ', trim(fgets(STDIN)));
}

// 標準入力を 1 行読み、整数列に分解する
function ints() {
    return array_map('intval', words());
}

// データ列を空白区切りで標準出力に書き込む
function echo_words(...$args) {
    echo implode(' ', $args), "\n";
}
</code></pre>
      </div>

      <p>以下のように疑問は尽きませんが、スピード優先で先へ進みます。<br /></p>

      <blockquote>
        <ul>
          <li>実は JS/TS のようにアロー関数を使った方が良いのか？<br /></li>
          <li><code>array_map</code> とは？<br /></li>
        </ul>
      </blockquote>
      <h3 id="ナップサック問題"><a href="#ナップサック問題">ナップサック問題</a></h3>
      <p>
        <a href="https://atcoder.jp/contests/dp">Educational DP Contest</a> の
        <a href="https://atcoder.jp/contests/dp/tasks/dp_d">D - Knapsack 1</a> を解きます。<br />
      </p>
      <h4 id="問題設定"><a href="#問題設定">問題設定</a></h4>
      <p>ナップサック問題は動的計画法の問題です。問題設定は次のとおりです。<br /></p>

      <p>
        \((重さ w_i, 価値 v_i)\) を持った \(N\) 個の荷物があります 。これらの荷物を重さ \(W\)
        まで収納可能なバッグに詰めていくとき、バッグの中の荷物の価値の総和の最大値を求めてください。<br />
      </p>
      <h4 id="解法: 動的計画法"><a href="#解法: 動的計画法">解法: 動的計画法</a></h4>
      <p>
        具体例として、重さ \(4\)
        まで荷物を詰められるバッグがあるとして、以下の初期配列を作成します。<br />
      </p>

      <figure>
        <img
          src="./img/2024-11-05-knapsack-1.png"
          alt="2024-11-05-knapsack-1.png"
          width="570px"
        /><br />
      </figure>

      <ul>
        <li>配列の添字は重さです。<br /></li>
        <li>配列の各スロットには、その重さを達成する最大価値を記録します。<br /></li>
      </ul>

      <p>具体的には、次のように計算します:<br /></p>

      <figure>
        <img src="./img/2024-11-05-knapsack-2.png" alt="2024-11-05-knapsack-2.png" /><br />
      </figure>

      <ul>
        <li>それぞれの荷物をバックに詰める・詰めないをすべて試すと \(O(2^N)\) になります<br /></li>
        <li>
          動的計画法により状態数を \(W\) 程度に削減したことで、 \(O(NW)\) で計算できます<br />
        </li>
      </ul>

      <p>
        このように \(N\) 個の荷物を処理し、最後に残った配列の中で最大の値 (価値) が答えです。<br />
      </p>
      <h4 id="実装"><a href="#実装">実装</a></h4>
      <p>
        以下の提出が受理されました (<a href="https://atcoder.jp/contests/dp/submissions/59465896"
          >340 ms</a
        >) 。良い PHP
        のコードではないかもしれませんが、スクリプト言語としては妥当な速度のように思いました
        (コンパイル言語の 10 倍遅い程度です) 。<br />
      </p>

      <div class="org-src-container">
        <pre><code class="src language-php">&lt;?php

// -------------------------------------------------------------------------------------------------
// テンプレート
// -------------------------------------------------------------------------------------------------

// 標準入力を 1 行読み、単語列に分解する
function words() {
    return explode(' ', trim(fgets(STDIN)));
}

// 標準入力を 1 行読み、整数列に分解する
function ints() {
    return array_map('intval', words());
}

// データ列を空白区切りで標準出力に書き込む
function echo_words(...$args) {
    echo implode(' ', $args), "\n";
}

// -------------------------------------------------------------------------------------------------
// Main
// -------------------------------------------------------------------------------------------------

function main() {
    // 荷物の数と最大の重さを取得する
    // 注: $w は上書きされるため $wMax とする
    list($n, $wMax) = ints();

    // 荷物の情報を取得する
    $ws = [];
    $vs = [];
    for ($i = 0; $i &lt; $n; $i++) {
        list($w, $v) = ints();
        $ws[$i] = $w;
        $vs[$i] = $v;
        // list($ws[], $vs[]) = ints();
    }

    // DP 配列を初期化する
    $dp = array_fill(0, $wMax + 1,  PHP_INT_MIN);
    $dp[0] = 0;
    $next_dp = array_fill(0, $wMax + 1,  PHP_INT_MIN);

    // 荷物を 1 つずつ処理して DP を実施
    for ($i = 0; $i &lt; $n; $i++) {
        // この荷物の情報を取得
        $dw = $ws[$i];
        $dv = $vs[$i];
        // この荷物を収納した場合・しなかった場合の内、
        // より高い価値を各スロットに記録する:
        for ($iw = 0; $iw &lt;= $wMax; $iw++) {
            if ($iw &gt;= $dw) {
                $next_dp[$iw] = max($dp[$iw], $dp[$iw - $dw] + $dv);
            } else {
                $next_dp[$iw] = $dp[$iw];
            }
        }

        [$dp, $next_dp] = [$next_dp, $dp]; // 昔の PHP だと動かない？
    }

    // 解答
    $result = max($dp);
    echo $result;
}

main();
</code></pre>
      </div>
      <h2 id="終わりに"><a href="#終わりに">終わりに</a></h2>
      <p>
        PHP 8.2
        を環境構築し、競技プログラミングの問題を解いてみました。まだまだ変なプログラムを書いている気がしますから、本格的に
        PHP に取り組む場合は知識を補填します。<br />
      </p>

      <p>
        また僕はテキストエディタや環境構築には強い方だと思いますが、 Web
        プログラミング・設計等の知識はほぼありません。イチからやり直し積み上げて行きたいと思います。<br />
      </p>
    </main>
    <footer role="contentinfo">
      <p>Styled with <a href="https://simplecss.org/">Simple.css</a></p>
      <div><a href="/index.html">Home</a><a href="https://github.com/toyboot4e">GitHub</a></div>
    </footer>
  </body>
</html>
